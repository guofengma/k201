# 安装 Kubernetes 插件

## 创建集群管理原账户（Cluster Admin）

编写配置文件 admin-role.yaml

    vi admin-role.yaml
    kind: ClusterRoleBinding
    apiVersion: rbac.authorization.k8s.io/v1beta1
    metadata:
      name: admin
      annotations:
        rbac.authorization.kubernetes.io/autoupdate: "true"
    roleRef:
      kind: ClusterRole
      name: cluster-admin
      apiGroup: rbac.authorization.k8s.io
    subjects:
    - kind: ServiceAccount
      name: admin
      namespace: kube-system
    ---
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: admin
      namespace: kube-system
      labels:
        kubernetes.io/cluster-service: "true"
        addonmanager.kubernetes.io/mode: Reconcile

执行命令创建账户

    kubectl create -f admin-role.yaml
    clusterrolebinding.rbac.authorization.k8s.io/admin created
    serviceaccount/admin created

获取新建账户的token

    kubectl -n kube-system get secret|grep admin-token
    admin-token-dvhv7                                kubernetes.io/service-account-token   3      15s

    kubectl -n kube-system describe secret admin-token-dvhv7
    Name:         admin-token-dvhv7
    Namespace:    kube-system
    Labels:       <none>
    Annotations:  kubernetes.io/service-account.name: admin
                kubernetes.io/service-account.uid: cd1d963a-3b34-11e9-8ce7-fa163ec5bf9e

    Type:  kubernetes.io/service-account-token

    Data
    ====
    ca.crt:     1025 bytes
    namespace:  11 bytes
    token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi10b2tlbi1kdmh2NyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImNkMWQ5NjNhLTNiMzQtMTFlOS04Y2U3LWZhMTYzZWM1YmY5ZSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbiJ9.TyVprdo9ag_tZPsfUSP-QXQ_jpkG3t7_u0sATsNvS2ZCd9aCs4Ci5IatJf_zKu4qHHDRAckL-aaNt0oK4rZ-jVoU_EUTK2hVcxBQaOtidP5lfMTIxcjjAjXuhnwyNHS9XuEFI4pJwO-4_l6q7lM-i1mhu0g5NIHMaGt22-GvEkWnvhon4LQOFCd2Mafdj_po2GrYByr34Xw92H-uVnzd2irP0lLThE9J1Xg2NvRqdfTZDeW8IG1bx6PDGz-lXnmF2b7S6daoNG6x5UBSysANLNpl-0pUFnx5Ux249-8zi2RyLdedyWj9zXiUp7BvAtfeiqwgT89M95WDHMrjcl4siw

在需要连接集群的机器上配置管理原token

    mkdir .kube
    vi .kube/config

    apiVersion: v1
    clusters:
    - cluster:
        insecure-skip-tls-verify: true
        server: https://10.70.93.138:6443
      name: test
    contexts:
    - context:
        cluster: test
        user: test
      name: test
    current-context: test
    kind: Config
    preferences: {}
    users:
    - name: test
      user:
        token: eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi10b2tlbi1kdmh2NyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImNkMWQ5NjNhLTNiMzQtMTFlOS04Y2U3LWZhMTYzZWM1YmY5ZSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbiJ9.TyVprdo9ag_tZPsfUSP-QXQ_jpkG3t7_u0sATsNvS2ZCd9aCs4Ci5IatJf_zKu4qHHDRAckL-aaNt0oK4rZ-jVoU_EUTK2hVcxBQaOtidP5lfMTIxcjjAjXuhnwyNHS9XuEFI4pJwO-4_l6q7lM-i1mhu0g5NIHMaGt22-GvEkWnvhon4LQOFCd2Mafdj_po2GrYByr34Xw92H-uVnzd2irP0lLThE9J1Xg2NvRqdfTZDeW8IG1bx6PDGz-lXnmF2b7S6daoNG6x5UBSysANLNpl-0pUFnx5Ux249-8zi2RyLdedyWj9zXiUp7BvAtfeiqwgT89M95WDHMrjcl4siw

## 下载Kubernetes客户端kubectl并安装

### macOS 安装

    brew install kubernetes-cli

### Windows

要在Windows上可以通过[Chocolatey](https://chocolatey.org/)软件包管理器安装kubectl

    choco install kubernetes-cli
    cd C:\users\yourusername
    mkdir .kube
    cd .kube
    New-Item config -type file

### CentOS

    cat <<EOF > /etc/yum.repos.d/kubernetes.repo
    [kubernetes]
    name=Kubernetes
    baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
    enabled=1
    gpgcheck=1
    repo_gpgcheck=1
    gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
    EOF
    yum install -y kubectl

## 安装 Kubernetes Dashboard

通过如下命令部署Dashboard插件

    kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml

等待插件部署完成

    kubectl -n kube-system get pods
    NAME                                   READY   STATUS    RESTARTS   AGE
    kubernetes-dashboard-57df4db6b-n7d7q   1/1     Running   0          45m

为了安全，现在Dashboard只能通过代理进行访问

    kubectl proxy

访问如下地址

可以通过上面创建的管理员账号的token 进行访问，也可以[创建普通账户](https://github.com/kubernetes/dashboard/wiki/Creating-sample-user)进行访问，在弹出的菜单中选择token，然后填入token内容

    http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/

## 部署 metrics-server 插件

创建配置文件 metrics-server.yaml，设置 --kubelet-insecure-tls 参数，跳过kubelet tls证书检查

    vi metrics-server.yaml
    args:
    - --logtostderr
    - --kubelet-insecure-tls

如果你各节点的主机名是未解析的，还需要启用coredns的hosts插件，因为metrics-server通过主机名去访问kubelet。

    kubectl edit configmap coredns -n kube-system
    apiVersion: v1
    data:
    Corefile: |
        .:53 {
            errors
            health
            hosts {
                192.168.115.116 k8s-m1
                192.168.115.117 k8s-m2
                192.168.115.118 k8s-m3
                192.168.115.119 k8s-s1
                192.168.115.120 k8s-s2
                fallthrough
            }
            kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            upstream
            fallthrough in-addr.arpa ip6.arpa
            }

    kubectl -n kube-system get pods
    NAME                                   READY   STATUS    RESTARTS   AGE
    coredns-86c58d9df4-5tww2               1/1     Running   0          3h38m
    coredns-86c58d9df4-wzggt               1/1     Running   0          3h38m
    # 通过删除pod进行重建以使配置生效
    kubectl -n kube-system delete pod coredns-86c58d9df4-5tww2
    kubectl -n kube-system delete pod coredns-86c58d9df4-wzggt

执行下面命令通过helm部署metrics-server

    helm install stable/metrics-server \
      -n metrics-server \
      --namespace kube-system \
      -f metrics-server.yaml

等待metrics-server部署完成

    kubectl get pods -n kube-system
    NAME                                   READY   STATUS              RESTARTS   AGE
    metrics-server-f4699888b-8g7r4         1/1     Running            0          84s

执行下面命令确保能够获取到nodes信息

    kubectl get --raw "/apis/metrics.k8s.io/v1beta1/nodes"

执行如下命令获取node资源使用情况

    kubectl top node

## 部署 Traefik Ingress 负载均衡

为了便于将集群中的服务暴露到集群外部，从集群外部访问，使用Helm将Traefik Ingress部署到Kubernetes上

编写配置文件

    vi traefik.yaml
    serviceType: NodePort
    replicas: 3
    resources:
      limits:
        cpu: 2
        memory: 4Gi
      requests:
        cpu: 4
        memory: 4Gi
    dashboard:
      enabled: true
      domain: traefik.example.com
    service:
      nodePorts:
        http: 30080
        https: 30443
    rbac:
      enabled: true
    metrics:
      prometheus:
        enabled: true

执行系列命令部署

    helm install stable/traefik --name traefik --namespace kube-system -f traefik.yaml

配置负载均衡

将节点的30080加到负载均衡（如 阿里云的ELB、Haproxy、F5等）后面，负载均衡对外提供80、443端口的访问。通过将traefik.example.com解析到负载均衡的VIP上就能够访问Traefik的dashboard了。
